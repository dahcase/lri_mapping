accounts[[i]] <- data.frame(spent = abs(spending_mean[i]), balance = balance,
month = time, debt = abs(debt))
}
account <- do.call(rbind, accounts)
account$spent <- as.character(account$spent)
library(tidyverse)
break_even <- c()
for (i in 1:length(spending_mean)) {
intmd <- select(filter
(account, spent == abs(spending_mean[i]) & balance > 500),
month)
break_even[i] <- ifelse(nrow(intmd) == 0, 0, min(intmd))
}
be_analysis <- data.frame(spent = abs(spending_mean), be = break_even)
ggplot(data = account, aes(x = month, y = balance, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = account, aes(x = month, y = debt, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = be_analysis) +
geom_point(aes(x = spent, y = be)) +
theme_bw()
cash <- 2067.84 #dollars
income <- (1961.79*2) - 885 - 768 #dollars per month
reserve <- 500 #dollars
debt_0_cc <- -6532.18 + -100 #dollars
debt_0_sl <- 0 -33736.26 + -33004.45 + -23928.24 #108685.28 #dollars
time <- 1:48 #months
debt_0_sl_vec <- c(debt_0_sl, (debt_0_sl*(1 + 0.06*c(1:20)))) #dollars
spending_mean <- seq(-600, -600, by = -50) #dollars
accounts <- list()
for (i in 1:length(spending_mean)) {
balance <- c() #dollars
debt <- c() #dollars
for (month in time) {
spending <- spending_mean[i] #rnorm(1,spending_mean[i],100) #dollars per month
balance_0 <- cash + income*month - reserve + spending*month + debt_0_cc +
debt_0_sl_vec[ceiling(month/12)]
if (balance_0 < 0) {
debt[month] = balance_0
} else {
debt[month] = 0
}
if (balance_0 < reserve) {
balance[month] = reserve;
} else {
balance[month] = balance_0
}
}
accounts[[i]] <- data.frame(spent = abs(spending_mean[i]), balance = balance,
month = time, debt = abs(debt))
}
account <- do.call(rbind, accounts)
account$spent <- as.character(account$spent)
library(tidyverse)
break_even <- c()
for (i in 1:length(spending_mean)) {
intmd <- select(filter
(account, spent == abs(spending_mean[i]) & balance > 500),
month)
break_even[i] <- ifelse(nrow(intmd) == 0, 0, min(intmd))
}
be_analysis <- data.frame(spent = abs(spending_mean), be = break_even)
ggplot(data = account, aes(x = month, y = balance, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = account, aes(x = month, y = debt, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = be_analysis) +
geom_point(aes(x = spent, y = be)) +
theme_bw()
View(account)
cash <- 2067.84 #dollars
income <- (1961.79*2) - 885 - 768 + 1000 #dollars per month
reserve <- 500 #dollars
debt_0_cc <- -6532.18 + -100 #dollars
debt_0_sl <- 0 -33736.26 + -33004.45 + -23928.24 #108685.28 #dollars
time <- 1:48 #months
debt_0_sl_vec <- c(debt_0_sl, (debt_0_sl*(1 + 0.06*c(1:20)))) #dollars
spending_mean <- seq(-600, -600, by = -50) #dollars
accounts <- list()
for (i in 1:length(spending_mean)) {
balance <- c() #dollars
debt <- c() #dollars
for (month in time) {
spending <- spending_mean[i] #rnorm(1,spending_mean[i],100) #dollars per month
balance_0 <- cash + income*month - reserve + spending*month + debt_0_cc +
debt_0_sl_vec[ceiling(month/12)]
if (balance_0 < 0) {
debt[month] = balance_0
} else {
debt[month] = 0
}
if (balance_0 < reserve) {
balance[month] = reserve;
} else {
balance[month] = balance_0
}
}
accounts[[i]] <- data.frame(spent = abs(spending_mean[i]), balance = balance,
month = time, debt = abs(debt))
}
account <- do.call(rbind, accounts)
account$spent <- as.character(account$spent)
library(tidyverse)
break_even <- c()
for (i in 1:length(spending_mean)) {
intmd <- select(filter
(account, spent == abs(spending_mean[i]) & balance > 500),
month)
break_even[i] <- ifelse(nrow(intmd) == 0, 0, min(intmd))
}
be_analysis <- data.frame(spent = abs(spending_mean), be = break_even)
ggplot(data = account, aes(x = month, y = balance, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = account, aes(x = month, y = debt, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = be_analysis) +
geom_point(aes(x = spent, y = be)) +
theme_bw()
cash <- 2067.84 #dollars
income <- 5454.27 - 885 - 768 #dollars per month (1961.79*2)
reserve <- 500 #dollars
debt_0_cc <- -6532.18 + -100 #dollars
debt_0_sl <- 0 -33736.26 + -33004.45 + -23928.24 #108685.28 #dollars
time <- 1:48 #months
debt_0_sl_vec <- c(debt_0_sl, (debt_0_sl*(1 + 0.06*c(1:20)))) #dollars
spending_mean <- seq(-600, -600, by = -50) #dollars
accounts <- list()
for (i in 1:length(spending_mean)) {
balance <- c() #dollars
debt <- c() #dollars
for (month in time) {
spending <- spending_mean[i] #rnorm(1,spending_mean[i],100) #dollars per month
balance_0 <- cash + income*month - reserve + spending*month + debt_0_cc +
debt_0_sl_vec[ceiling(month/12)]
if (balance_0 < 0) {
debt[month] = balance_0
} else {
debt[month] = 0
}
if (balance_0 < reserve) {
balance[month] = reserve;
} else {
balance[month] = balance_0
}
}
accounts[[i]] <- data.frame(spent = abs(spending_mean[i]), balance = balance,
month = time, debt = abs(debt))
}
account <- do.call(rbind, accounts)
account$spent <- as.character(account$spent)
library(tidyverse)
break_even <- c()
for (i in 1:length(spending_mean)) {
intmd <- select(filter
(account, spent == abs(spending_mean[i]) & balance > 500),
month)
break_even[i] <- ifelse(nrow(intmd) == 0, 0, min(intmd))
}
be_analysis <- data.frame(spent = abs(spending_mean), be = break_even)
ggplot(data = account, aes(x = month, y = balance, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = account, aes(x = month, y = debt, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = be_analysis) +
geom_point(aes(x = spent, y = be)) +
theme_bw()
cash <- 2067.84 #dollars
income <- 5893.77 - 885 - 768 #dollars per month (1961.79*2)
reserve <- 500 #dollars
debt_0_cc <- -6532.18 + -100 #dollars
debt_0_sl <- 0 -33736.26 + -33004.45 + -23928.24 #108685.28 #dollars
time <- 1:48 #months
debt_0_sl_vec <- c(debt_0_sl, (debt_0_sl*(1 + 0.06*c(1:20)))) #dollars
spending_mean <- seq(-600, -600, by = -50) #dollars
accounts <- list()
for (i in 1:length(spending_mean)) {
balance <- c() #dollars
debt <- c() #dollars
for (month in time) {
spending <- spending_mean[i] #rnorm(1,spending_mean[i],100) #dollars per month
balance_0 <- cash + income*month - reserve + spending*month + debt_0_cc +
debt_0_sl_vec[ceiling(month/12)]
if (balance_0 < 0) {
debt[month] = balance_0
} else {
debt[month] = 0
}
if (balance_0 < reserve) {
balance[month] = reserve;
} else {
balance[month] = balance_0
}
}
accounts[[i]] <- data.frame(spent = abs(spending_mean[i]), balance = balance,
month = time, debt = abs(debt))
}
account <- do.call(rbind, accounts)
account$spent <- as.character(account$spent)
library(tidyverse)
break_even <- c()
for (i in 1:length(spending_mean)) {
intmd <- select(filter
(account, spent == abs(spending_mean[i]) & balance > 500),
month)
break_even[i] <- ifelse(nrow(intmd) == 0, 0, min(intmd))
}
be_analysis <- data.frame(spent = abs(spending_mean), be = break_even)
ggplot(data = account, aes(x = month, y = balance, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = account, aes(x = month, y = debt, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = be_analysis) +
geom_point(aes(x = spent, y = be)) +
theme_bw()
cash <- 2067.84 #dollars
income <- 5893.77 - 885 #- 768 #dollars per month (1961.79*2)
reserve <- 500 #dollars
debt_0_cc <- -6532.18 + -100 #dollars
debt_0_sl <- 0 - 108685.28 #dollars
time <- 1:48 #months
debt_0_sl_vec <- c(debt_0_sl, (debt_0_sl*(1 + 0.06*c(1:20)))) #dollars
spending_mean <- seq(-600, -600, by = -50) #dollars
accounts <- list()
for (i in 1:length(spending_mean)) {
balance <- c() #dollars
debt <- c() #dollars
for (month in time) {
spending <- spending_mean[i] #rnorm(1,spending_mean[i],100) #dollars per month
balance_0 <- cash + income*month - reserve + spending*month + debt_0_cc +
debt_0_sl_vec[ceiling(month/12)]
if (balance_0 < 0) {
debt[month] = balance_0
} else {
debt[month] = 0
}
if (balance_0 < reserve) {
balance[month] = reserve;
} else {
balance[month] = balance_0
}
}
accounts[[i]] <- data.frame(spent = abs(spending_mean[i]), balance = balance,
month = time, debt = abs(debt))
}
account <- do.call(rbind, accounts)
account$spent <- as.character(account$spent)
library(tidyverse)
break_even <- c()
for (i in 1:length(spending_mean)) {
intmd <- select(filter
(account, spent == abs(spending_mean[i]) & balance > 500),
month)
break_even[i] <- ifelse(nrow(intmd) == 0, 0, min(intmd))
}
be_analysis <- data.frame(spent = abs(spending_mean), be = break_even)
ggplot(data = account, aes(x = month, y = balance, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = account, aes(x = month, y = debt, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = be_analysis) +
geom_point(aes(x = spent, y = be)) +
theme_bw()
cash <- 2067.84 #dollars
income <- 5893.77 - 885 #- 768 #dollars per month (1961.79*2)
reserve <- 500 #dollars
debt_0_cc <- -6532.18 + -100 #dollars
debt_0_sl <- 0 - 108685.28 #dollars
time <- 1:48 #months
debt_0_sl_vec <- c(debt_0_sl, (debt_0_sl*(1 + 0.06*c(1:20)))) #dollars
spending_mean <- seq(-600, -600, by = -50) #dollars
accounts <- list()
for (i in 1:length(spending_mean)) {
balance <- c() #dollars
debt <- c() #dollars
for (month in time) {
spending <- spending_mean[i] #rnorm(1,spending_mean[i],100) #dollars per month
balance_0 <- cash + income*month - reserve + spending*month + debt_0_cc +
debt_0_sl_vec[ceiling(month/12)]
if (balance_0 < 0) {
debt[month] = balance_0
} else {
debt[month] = 0
}
if (balance_0 < reserve) {
balance[month] = reserve;
} else {
balance[month] = balance_0
}
}
accounts[[i]] <- data.frame(spent = abs(spending_mean[i]), balance = balance,
month = time, debt = abs(debt))
}
account <- do.call(rbind, accounts)
account$spent <- as.character(account$spent)
library(tidyverse)
break_even <- c()
for (i in 1:length(spending_mean)) {
intmd <- select(filter
(account, spent == abs(spending_mean[i]) & balance > 500),
month)
break_even[i] <- ifelse(nrow(intmd) == 0, 0, min(intmd))
}
be_analysis <- data.frame(spent = abs(spending_mean), be = break_even)
ggplot(data = account, aes(x = month, y = balance, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = account, aes(x = month, y = debt, group = spent)) + geom_line(aes(col = spent)) +
theme_bw()
ggplot(data = be_analysis) +
geom_point(aes(x = spent, y = be)) +
theme_bw()
mydat <- read_csv(file = 'J:/WORK/11_geospatial/10_mbg/input_data/w_imp.csv', col_types = 'ddddcddcdcddddddd')
library(tidyverse)
mydat <- read_csv(file = 'J:/WORK/11_geospatial/10_mbg/input_data/w_imp.csv', col_types = 'ddddcddcdcddddddd')
perudat <- filter(mydat, country = 'PER')
perudat <- filter(mydat, country == 'PER')
hist(perudat$N)
summary(perudat$N)
View(perudat)
5114332/703
perudat <- filter(mydat, country == 'PER' & year > 1997)
729557/703
if ('gam' %in% child_model_names) {
tic("Stacking - GAM")
gam <- fit_gam_child_model(df                = the_data,
model_name        = 'gam',
fold_id_col       = 'fold_id',
covariates        = all_fixed_effects,
additional_terms  = 'year',
weight_column     = 'weight',
bam               = FALSE,
spline_args       = list(bs = 'ts', k = 3),
auto_model_select = TRUE,
indicator         = indicator,
indicator_family  = indicator_family,
cores             = cores_to_use)
toc(log = T)
}
rm(list = ls())
indi_fam <- "water"
agg_level <- ''
sdg <- F
root <- ifelse(Sys.info()[1]=="Windows", "J:/", "/snfs1/")
repo <- ifelse(Sys.info()[1]=="Windows", 'C:/Users/adesh/Documents/WASH/wash_code/01_collapse/',
'/share/code/geospatial/adesh/wash_mapping/01_collapse/')
if(Sys.info()[1]!="Windows") {
package_lib <- paste0(root,'temp/geospatial/packages')
.libPaths(package_lib)
}
if(!require(pacman)) {
install.packages("pacman"); require(pacman)}
p_load(dplyr, readr)
data_type == 'pt'
data_type = 'pt'
if (!("pt_collapse" %in% ls()) & data_type == 'pt') {
name <- load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_07_20.Rdata'))
Encoding(pt_collapse$w_source_drink) <- "windows-1252"
Encoding(pt_collapse$w_source_other) <- "windows-1252"
Encoding(pt_collapse$t_type) <- "windows-1252"
pt_collapse <- get(name)
}
if (!("pt_collapse" %in% ls()) & data_type == 'pt') {
name <- load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_07_31.Rdata'))
Encoding(pt_collapse$w_source_drink) <- "windows-1252"
Encoding(pt_collapse$w_source_other) <- "windows-1252"
Encoding(pt_collapse$t_type) <- "windows-1252"
pt_collapse <- get(name)
}
if (!("poly_collapse" %in% ls()) & data_type == 'poly') {
name <- load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/polys_collapsed_2017_07_31.Rdata'))
Encoding(poly_collapse$w_source_drink) <- "windows-1252"
Encoding(poly_collapse$w_source_other) <- "windows-1252"
Encoding(poly_collapse$t_type) <- "windows-1252"
pt_collapse <- get(name)
rm(poly_collapse)
}
if (!("definitions" %in% ls())) {
if (indi_fam == "sani") {
definitions <- read.csv(paste0(root,'WORK/11_geospatial/wash/definitions/t_type_defined_updated_2017_07_21.csv'),
encoding="windows-1252", stringsAsFactors = F)
} else {
definitions <- read.csv(paste0(root,'WORK/11_geospatial/wash/definitions/w_source_defined_updated_2017_07_21.csv'),
encoding="windows-1252", stringsAsFactors = F)
definitions2 <- read.csv(paste0(root,'WORK/11_geospatial/wash/definitions/w_other_defined_updated_2017_07_21.csv'),
encoding="windows-1252", stringsAsFactors = F)
definitions2 <- rename(definitions2, sdg2 = sdg)
}
}
rm(list = setdiff(ls(),c('definitions','pt_collapse','definitions2','indi_fam','repo','data_type','root','agg_level', 'sdg')))
setwd(repo)
source('functions/hh_cw.R')
source('functions/address_missing.R')
source('functions/cw_indi.R')
source('functions/agg_wash.R')
source('functions/define_wash.R')
ptdat_0 <- dplyr::select(pt_collapse, nid, iso3, lat, long, survey_series, hhweight, urban, w_source_drink, w_source_other,
hh_size, year_start,hhweight,shapefile,location_code)
if (data_type == 'pt') {
ptdat <- mutate(ptdat_0, cluster_id = paste(iso3, lat, long, survey_series, year_start, sep = "_"))
} else {
ptdat <- mutate(ptdat_0, cluster_id = paste(iso3, shapefile, location_code, survey_series, year_start, sep = "_"))
}
perudat <- filter(ptdat, iso3 == 'PER')
head(perudat)
perudat <- filter(perudat, nid == 146860)
View(definitions)
perudat <- filter(ptdat, nid == 146860)
perudat <- filter(ptdat, iso3 == 'PER')
count(perudat, survey_series, year_start)
View(perudat)
data_type = 'poly'
data_type = 'poly'
if (!("pt_collapse" %in% ls()) & data_type == 'pt') {
name <- load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_07_31.Rdata'))
Encoding(pt_collapse$w_source_drink) <- "windows-1252"
Encoding(pt_collapse$w_source_other) <- "windows-1252"
Encoding(pt_collapse$t_type) <- "windows-1252"
pt_collapse <- get(name)
}
if (!("poly_collapse" %in% ls()) & data_type == 'poly') {
name <- load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/polys_collapsed_2017_07_31.Rdata'))
Encoding(poly_collapse$w_source_drink) <- "windows-1252"
Encoding(poly_collapse$w_source_other) <- "windows-1252"
Encoding(poly_collapse$t_type) <- "windows-1252"
pt_collapse <- get(name)
rm(poly_collapse)
}
filter(poly_collapse, iso3 = 'PER')
filter(pt_collapse, iso3 = 'PER')
filter(pt_collapse, iso3 == 'PER')
head(pt_collapse)
head(pt_collapse)
rm(list = ls())
indi_fam <- "water"
agg_level <- ''
sdg <- F
root <- ifelse(Sys.info()[1]=="Windows", "J:/", "/snfs1/")
repo <- ifelse(Sys.info()[1]=="Windows", 'C:/Users/adesh/Documents/WASH/wash_code/01_collapse/',
'/share/code/geospatial/adesh/wash_mapping/01_collapse/')
if(Sys.info()[1]!="Windows") {
package_lib <- paste0(root,'temp/geospatial/packages')
.libPaths(package_lib)
}
if(!require(pacman)) {
install.packages("pacman"); require(pacman)}
p_load(dplyr, readr)
data_type = 'poly'
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_07_31.Rdata'))
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/polys_collapsed_2017_07_31.Rdata'))
alldat <- bind_rows(poly_collapse, pt_collapse)
peru_dat <- filter(alldat, iso3 == 'PER')
count(peru_dat, survey_series, year)
count(peru_dat, survey_series, year_start)
rm(list = ls())
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_08_01.Rdata'))
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/polys_collapsed_2017_08_01.Rdata'))
root <- ifelse(Sys.info()[1]=="Windows", "J:/", "/snfs1/")
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_08_01.Rdata'))
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/polys_collapsed_2017_08_01.Rdata'))
alldat <- bind_rows(poly_collapse, pt_collapse)
peru_dat <- filter(alldat, iso3 == 'PER')
count(peru_dat, survey_series, year)
count(peru_dat, survey_series, year_start)
peru_dat <- filter(alldat, iso3 == 'PER')
count(peru_dat, survey_series, year_start)
alldat_0801 <- alldat
ls()
setdiff(ls(), 'alldat_0801')
rm(list = setdiff(ls(), 'alldat_0801'))
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_07_31.Rdata'))
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/polys_collapsed_2017_07_31.Rdata'))
alldat <- bind_rows(poly_collapse, pt_collapse)
peru_dat <- filter(alldat, iso3 == 'PER')
count(peru_dat, survey_series, year_start)
alldat_0731 <- alldat
root <- ifelse(Sys.info()[1]=="Windows", "J:/", "/snfs1/")
rm(list = setdiff(ls(), c('alldat_0801',root)))
root <- ifelse(Sys.info()[1]=="Windows", "J:/", "/snfs1/")
rm(list = setdiff(ls(), c('alldat_0801','root')))
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_07_31.Rdata'))
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/polys_collapsed_2017_07_31.Rdata'))
alldat <- bind_rows(poly_collapse, pt_collapse)
peru_dat <- filter(alldat, iso3 == 'PER')
count(peru_dat, survey_series, year_start)
alldat_0731 <- alldat
perudat2 <- filter(alldat_0731, iso3 == 'PER')
count(perudat2, iso3, year_start)
perudat <- filter(alldat_0801, iso3 == 'PER')
count(perudat, nid)
count(perudat2, nid)
filter(perudat, nid == 303664)
filter(perudat, nid == 303663)
peru0801 <- filter(alldat_0801, iso3 == 'PER')
count(peru0801, nid, survey_series, year_start)
peru0731 <- filter(alldat_0731, iso3 == 'PER')
count(peru0731, nid, survey_series, year_start)
peru0801 <- filter(alldat_0801, iso3 == 'PER')
count(peru0801, nid, survey_names, year_start)
head(peru0801)
peru0801 <- filter(alldat_0801, iso3 == 'PER')
count(peru0801, nid, survey_name, year_start)
peru0731 <- filter(alldat_0731, iso3 == 'PER')
count(peru0731, nid, survey_name, year_start)
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_08_01.Rdata'))
root <- ifelse(Sys.info()[1]=="Windows", "J:/", "/snfs1/")
load(paste0(root,'LIMITED_USE/LU_GEOSPATIAL/geo_matched/wash/points_collapsed_2017_08_01.Rdata'))
filter(pt_collapse, iso3 == 'PER')
perudat <- filter(pt_collapse, iso3 == 'PER')
head(perudat)
perudat <- filter(perudat, nid == '146860')
root <- ifelse(Sys.info()[1]=="Windows", "J:/", "/snfs1/")
data_type <- 'pt'
data_type <- 'pt'
